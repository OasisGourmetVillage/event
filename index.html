<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Oasis Gourmet Village | Arcade RPS</title>
  <style>
    :root{
      /* ====== (중요) 버튼/LED 위치 미세조정용 ======
         아래 퍼센트 값은 "오락기 이미지(cabinet.png)" 위에 얹히는 위치입니다.
         만약 클릭이 살짝 빗나가면, 이 값만 조금씩 조정하시면 됩니다. */

      /* 중앙 LED 원 영역(정사각형) */
      --led-left: 24.5%;
      --led-top: 25.3%;
      --led-size: 51%;

      /* 버튼 3개 영역(원형 버튼 터치 영역) */
      --btn-size: 18.8%;
      --btn-top: 63.5%;
      --btn-gap: 7.6%;      /* 버튼 간 간격 */
      --btn-left-1: 16.5%;  /* 빨강(가위) */
      --btn-left-2: 40.6%;  /* 파랑(바위) */
      --btn-left-3: 64.8%;  /* 노랑(보) */

      /* 하단 START(게임 시작하기) 버튼 터치 영역 */
      --start-left: 20%;
      --start-top: 79.8%;
      --start-width: 60%;
      --start-height: 10.5%;

      /* 디버그(터치 영역 표시): true로 바꾸면 레이아웃 조정이 쉬움 */
      --debug: 0;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:#000;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom);
    }

    /* 모바일 세로 포스터형 */
    .stage{
      width: min(92vw, 520px);
      aspect-ratio: 9 / 16;         /* 모바일 세로 고정 */
      position: relative;
      overflow:hidden;
      border-radius: 18px;
      background:#000;
      box-shadow: 0 26px 90px rgba(0,0,0,.65);
    }

    .cabinet{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit: cover;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }

    /* 중앙 LED(캔버스) */
    #ledCanvas{
      position:absolute;
      left: var(--led-left);
      top: var(--led-top);
      width: var(--led-size);
      height: var(--led-size);
      border-radius: 999px;
      filter: drop-shadow(0 0 18px rgba(255,60,60,.26));
      pointer-events:none;
    }

    /* 터치 영역 공통 */
    .hit{
      position:absolute;
      border-radius: 999px;
      background: rgba(255,255,255, calc(var(--debug) * 0.10));
      outline: calc(var(--debug) * 2px) solid rgba(0,255,255,.7);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    /* 버튼(가위/바위/보) */
    .btn{
      width: var(--btn-size);
      height: var(--btn-size);
      top: var(--btn-top);
    }
    #btnScissors{ left: var(--btn-left-1); }
    #btnRock{ left: var(--btn-left-2); }
    #btnPaper{ left: var(--btn-left-3); }

    /* START 영역은 네모 느낌 */
    #btnStart{
      left: var(--start-left);
      top: var(--start-top);
      width: var(--start-width);
      height: var(--start-height);
      border-radius: 14px;
      outline: calc(var(--debug) * 2px) solid rgba(255,210,0,.7);
      background: rgba(255,255,255, calc(var(--debug) * 0.08));
    }

    /* 상태/결과 HUD */
    .hud{
      position:absolute;
      left: 4.2%;
      right: 4.2%;
      top: 3.3%;
      display:flex;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .chip{
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.42);
      border: 1px solid rgba(255,255,255,.14);
      font-weight: 800;
      font-size: 12px;
      letter-spacing:.3px;
      backdrop-filter: blur(3px);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .chip b{ font-size: 14px; }

    /* 하단 메시지 */
    .msg{
      position:absolute;
      left: 6%;
      right: 6%;
      bottom: 2.4%;
      text-align:center;
      font-weight: 900;
      letter-spacing:.3px;
      font-size: 13px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 0 16px rgba(0,0,0,.55);
      pointer-events:none;
    }
    .msg small{
      display:block;
      margin-top:6px;
      font-weight:700;
      color: rgba(255,255,255,.72);
      line-height:1.35;
    }

    /* 쿠폰 모달 */
    .modal{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(4px);
      z-index: 50;
    }
    .modalCard{
      width: min(92%, 380px);
      border-radius: 18px;
      background: rgba(12,14,20,.92);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 26px 90px rgba(0,0,0,.65);
      padding: 14px;
      text-align:center;
    }
    .modalTitle{
      font-weight: 1000;
      letter-spacing:.6px;
      font-size: 18px;
      margin-bottom: 10px;
    }
    .modalSub{
      font-size: 12px;
      color: rgba(255,255,255,.75);
      line-height:1.4;
      margin-bottom: 12px;
    }
    .qr{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px 0;
    }
    .payload{
      margin-top:10px;
      font-size: 11px;
      color: rgba(255,255,255,.70);
      word-break: break-all;
      line-height:1.35;
    }
    .modalBtn{
      margin-top: 12px;
      width:100%;
      border:0;
      border-radius: 14px;
      padding: 12px 10px;
      font-weight: 1000;
      background:#fff;
      color:#111;
      cursor:pointer;
    }

    /* 결과 색 */
    .win{ color:#27d17c; }
    .draw{ color:#2f76ff; }
    .lose{ color:rgba(255,255,255,.82); }
  </style>
</head>

<body>
  <div class="stage" id="stage">
    <!-- 오락기 프레임 이미지 -->
    <img class="cabinet" src="assets/cabinet.png" alt="Arcade Cabinet" />

    <!-- LED 캔버스(중앙 원형) -->
    <canvas id="ledCanvas" width="420" height="420"></canvas>

    <!-- 클릭 영역(투명) -->
    <div class="hit btn" id="btnScissors" aria-label="가위"></div>
    <div class="hit btn" id="btnRock" aria-label="바위"></div>
    <div class="hit btn" id="btnPaper" aria-label="보"></div>
    <div class="hit" id="btnStart" aria-label="게임 시작"></div>

    <!-- HUD -->
    <div class="hud">
      <div class="chip">STREAK <b id="streakNow">0</b></div>
      <div class="chip">BEST <b id="streakBest">0</b></div>
    </div>

    <div class="msg" id="msg">
      READY
      <small>하단 “게임 시작하기”를 눌러 시작하세요.</small>
    </div>

    <!-- 쿠폰 모달 -->
    <div class="modal" id="modal">
      <div class="modalCard">
        <div class="modalTitle" id="modalTitle">COUPON UNLOCKED</div>
        <div class="modalSub" id="modalSub">계산대에서 QR을 제시해 주세요. (1회/당일)</div>
        <div class="qr" id="qrcode"></div>
        <div class="payload" id="payloadText">-</div>
        <button class="modalBtn" id="closeModal">확인</button>
      </div>
    </div>
  </div>

  <!-- QRCode.js -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script>
    /***********************
     * CONFIG (나중에 여기만 수정)
     ***********************/
    const CONFIG = {
      brand: "OGV",
      rewards: [
        { streak: 3,  title: "30% OFF",  code: "DISC30" },
        { streak: 5,  title: "50% OFF",  code: "DISC50" },
        { streak: 10, title: "100% OFF", code: "FREE100" }
      ],
      // 무승부는 연승 유지(원하시면 false로 바꾸면 DRAW에도 초기화 가능)
      drawKeepsStreak: true,
      // 티어별 1일 1회 제한
      dailyOnePerTier: true
    };

    /***********************
     * 상태
     ***********************/
    const choices = ["가위","바위","보"];
    let running = false;      // 게임이 시작되었는가
    let rolling = false;      // 현재 롤링 중인가
    let currentCPU = "가위";  // 롤링에 의해 표시되는 현재 CPU 값
    let rollIndex = 0;

    // 롤링 속도(작을수록 빠름)
    let intervalMs = 90;
    let rollTimer = null;

    // 멈출 때 감속
    let stopping = false;

    // 기록
    let streak = 0;
    let best = 0;

    /***********************
     * DOM
     ***********************/
    const msg = document.getElementById("msg");
    const streakNow = document.getElementById("streakNow");
    const streakBest = document.getElementById("streakBest");

    const btnStart = document.getElementById("btnStart");
    const btnScissors = document.getElementById("btnScissors");
    const btnRock = document.getElementById("btnRock");
    const btnPaper = document.getElementById("btnPaper");

    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const modalSub = document.getElementById("modalSub");
    const payloadText = document.getElementById("payloadText");
    const closeModal = document.getElementById("closeModal");
    const qrWrap = document.getElementById("qrcode");

    /***********************
     * 날짜키(일 단위 저장)
     ***********************/
    function dayKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${y}${m}${dd}`;
    }

    function loadToday(){
      const dk = dayKey();
      const saved = localStorage.getItem("ogv_day");
      if(saved !== dk){
        localStorage.setItem("ogv_day", dk);
        localStorage.setItem("ogv_streak", "0");
        localStorage.setItem("ogv_best", "0");
        // 티어 발급키는 그대로 두면 날짜가 달라져도 키가 달라지므로 자연스럽게 리셋됨
      }
      streak = parseInt(localStorage.getItem("ogv_streak") || "0", 10);
      best = parseInt(localStorage.getItem("ogv_best") || "0", 10);
      renderScore();
    }

    function saveScore(){
      localStorage.setItem("ogv_streak", String(streak));
      localStorage.setItem("ogv_best", String(best));
    }

    function renderScore(){
      streakNow.textContent = streak;
      streakBest.textContent = best;
    }

    /***********************
     * 판정
     ***********************/
    function judge(me, cpu){
      if(me === cpu) return "DRAW";
      if(
        (me==="가위" && cpu==="보") ||
        (me==="바위" && cpu==="가위") ||
        (me==="보" && cpu==="바위")
      ) return "WIN";
      return "LOSE";
    }

    function bestRewardForStreak(s){
      const sorted = [...CONFIG.rewards].sort((a,b)=>b.streak-a.streak);
      return sorted.find(r => s >= r.streak) || null;
    }

    function issuedKey(code){
      return `issued:${dayKey()}:${code}`;
    }

    function buildPayload(code, tier){
      const rand = Math.random().toString(16).slice(2,8).toUpperCase();
      // 예: OGV|DISC30|20260108|A1B2C3|TIER3|NOW5
      return `${CONFIG.brand}|${code}|${dayKey()}|${rand}|TIER${tier}|NOW${streak}`;
    }

    /***********************
     * 쿠폰 모달
     ***********************/
    function openCoupon(reward){
      const key = issuedKey(reward.code);

      modal.style.display = "flex";
      modalTitle.textContent = `COUPON UNLOCKED · ${reward.title}`;
      modalSub.textContent = "계산대에서 QR을 제시해 주세요. (1회/당일)";

      qrWrap.innerHTML = "";
      let payload = "";

      if(CONFIG.dailyOnePerTier && localStorage.getItem(key) === "1"){
        payload = "ALREADY ISSUED TODAY";
        payloadText.textContent = payload;
        return;
      }

      localStorage.setItem(key, "1");
      payload = buildPayload(reward.code, reward.streak);
      payloadText.textContent = payload;

      new QRCode(qrWrap, { text: payload, width: 210, height: 210 });
    }

    function closeCoupon(){
      modal.style.display = "none";
    }

    closeModal.addEventListener("click", closeCoupon);
    modal.addEventListener("click", (e) => {
      if(e.target === modal) closeCoupon();
    });

    /***********************
     * LED(도트) 렌더링
     ***********************/
    const led = document.getElementById("ledCanvas");
    const ctx = led.getContext("2d");

    // 29x29 도트 그리드
    const N = 29;

    // 도트 패턴(간단하지만 “전자식” 느낌)
    // 29x29 문자열 배열 (1=ON)
    const PAT = {
      "가위": makePatternScissors(),
      "바위": makePatternRock(),
      "보":   makePatternPaper()
    };

    function glowColorFor(choice){
      if(choice==="가위") return "rgba(255,80,80,1)";
      if(choice==="바위") return "rgba(80,150,255,1)";
      return "rgba(255,210,80,1)";
    }

    function drawLED(choice){
      const w = led.width, h = led.height;
      ctx.clearRect(0,0,w,h);

      // 원형 스크린 느낌(비네트 + 글로우)
      const g = ctx.createRadialGradient(w*0.5,h*0.5,w*0.08, w*0.5,h*0.5,w*0.52);
      g.addColorStop(0,"rgba(0,0,0,.10)");
      g.addColorStop(1,"rgba(0,0,0,.78)");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,w,h);

      // 링
      ctx.beginPath();
      ctx.arc(w*0.5,h*0.5,w*0.48,0,Math.PI*2);
      ctx.strokeStyle = "rgba(120,160,255,.25)";
      ctx.lineWidth = 6;
      ctx.stroke();

      // 도트 렌더
      const cell = Math.floor(w / N);
      const r = Math.floor(cell * 0.33);
      const pat = PAT[choice];
      const onColor = glowColorFor(choice);

      for(let y=0;y<N;y++){
        for(let x=0;x<N;x++){
          const cx = x*cell + cell/2;
          const cy = y*cell + cell/2;

          // off dot
          ctx.beginPath();
          ctx.arc(cx,cy,r,0,Math.PI*2);
          ctx.fillStyle = "rgba(255,255,255,.06)";
          ctx.fill();

          if(pat[y][x]){
            // glow
            ctx.beginPath();
            ctx.arc(cx,cy,r+2,0,Math.PI*2);
            ctx.globalAlpha = 0.22;
            ctx.fillStyle = onColor;
            ctx.fill();
            ctx.globalAlpha = 1;

            // on dot
            ctx.beginPath();
            ctx.arc(cx,cy,r,0,Math.PI*2);
            ctx.fillStyle = onColor;
            ctx.fill();
          }
        }
      }
    }

    /***********************
     * 롤링 / 감속 / 정지
     ***********************/
    function startGame(){
      if(running) return;
      running = true;
      msg.innerHTML = `ROLLING<br/><small>빨강(가위) / 파랑(바위) / 노랑(보) 버튼을 눌러 멈추세요.</small>`;
      startRolling();
    }

    function startRolling(){
      rolling = true;
      stopping = false;
      intervalMs = 90;

      if(rollTimer) clearInterval(rollTimer);
      rollTimer = setInterval(() => {
        currentCPU = choices[rollIndex % 3];
        rollIndex++;
        drawLED(currentCPU);
      }, intervalMs);
    }

    function slowStopThenResolve(meChoice){
      if(!running || !rolling || stopping) return;
      stopping = true;

      // 감속 단계(오락기 느낌)
      const steps = [110, 140, 180, 230, 300];
      let i = 0;

      const slow = setInterval(() => {
        i++;
        if(rollTimer) clearInterval(rollTimer);

        intervalMs = steps[Math.min(i, steps.length-1)];
        rollTimer = setInterval(() => {
          currentCPU = choices[rollIndex % 3];
          rollIndex++;
          drawLED(currentCPU);
        }, intervalMs);

        if(i >= steps.length){
          clearInterval(slow);
          // 마지막 한 번 보여주고 정지
          setTimeout(() => {
            stopRolling();
            resolveRound(meChoice, currentCPU);
          }, intervalMs + 60);
        }
      }, 170);
    }

    function stopRolling(){
      rolling = false;
      stopping = false;
      if(rollTimer) clearInterval(rollTimer);
      rollTimer = null;
    }

    function resolveRound(me, cpu){
      const out = judge(me, cpu);

      let cls = "";
      if(out==="WIN"){
        cls = "win";
        streak += 1;
        if(streak > best) best = streak;
        msg.innerHTML = `<span class="${cls}">WIN</span><br/><small>YOU: ${me} / CPU: ${cpu} · ${streak} STREAK</small>`;
      } else if(out==="DRAW"){
        cls = "draw";
        if(!CONFIG.drawKeepsStreak){
          streak = 0;
        }
        msg.innerHTML = `<span class="${cls}">DRAW</span><br/><small>YOU: ${me} / CPU: ${cpu} · STREAK ${streak}</small>`;
      } else {
        cls = "lose";
        streak = 0;
        msg.innerHTML = `<span class="${cls}">LOSE</span><br/><small>YOU: ${me} / CPU: ${cpu} · STREAK RESET</small>`;
      }

      saveScore();
      renderScore();

      // 보상 체크
      const reward = bestRewardForStreak(streak);
      if(reward){
        // 0.6초 후 쿠폰 띄우기(연출)
        setTimeout(() => openCoupon(reward), 600);
      }

      // 1.5초 후 자동 재롤링(오락기 느낌)
      setTimeout(() => {
        if(modal.style.display === "flex") return; // 쿠폰 모달 열려있으면 멈춤
        msg.innerHTML = `ROLLING<br/><small>버튼을 눌러 멈추세요.</small>`;
        startRolling();
      }, 1500);
    }

    /***********************
     * 이벤트 바인딩
     ***********************/
    btnStart.addEventListener("click", startGame);

    btnScissors.addEventListener("click", () => slowStopThenResolve("가위"));
    btnRock.addEventListener("click", () => slowStopThenResolve("바위"));
    btnPaper.addEventListener("click", () => slowStopThenResolve("보"));

    // 모달 닫으면 다시 롤링 재개
    closeModal.addEventListener("click", () => {
      closeCoupon();
      if(running){
        msg.innerHTML = `ROLLING<br/><small>버튼을 눌러 멈추세요.</small>`;
        startRolling();
      }
    });

    /***********************
     * 초기화
     ***********************/
    loadToday();
    drawLED("가위");

    // 첫 화면 안내(오락기 느낌 유지)
    msg.innerHTML = `READY<br/><small>하단 “게임 시작하기”를 눌러 시작하세요.</small>`;

    /***********************
     * 패턴 생성(29x29 boolean[][])
     ***********************/
    function blank(){
      return Array.from({length:N}, () => Array.from({length:N}, () => false));
    }
    function setDot(p,x,y){
      if(x>=0 && x<N && y>=0 && y<N) p[y][x] = true;
    }
    function line(p,x1,y1,x2,y2){
      const dx = Math.abs(x2-x1), sx = x1<x2?1:-1;
      const dy = -Math.abs(y2-y1), sy = y1<y2?1:-1;
      let err = dx+dy, e2;
      while(true){
        setDot(p,x1,y1);
        if(x1===x2 && y1===y2) break;
        e2 = 2*err;
        if(e2 >= dy){ err += dy; x1 += sx; }
        if(e2 <= dx){ err += dx; y1 += sy; }
      }
    }

    // 바위(주먹) 실루엣
    function makePatternRock(){
      const p = blank();
      // 둥근 주먹 형태
      for(let y=9; y<=22; y++){
        for(let x=7; x<=21; x++){
          const cx = 14, cy = 16;
          const rx = 7.8, ry = 7.0;
          const v = ((x-cx)*(x-cx))/(rx*rx) + ((y-cy)*(y-cy))/(ry*ry);
          if(v <= 1.0) setDot(p,x,y);
        }
      }
      // 아래 손목
      for(let y=22; y<=25; y++){
        for(let x=11; x<=17; x++) setDot(p,x,y);
      }
      return p;
    }

    // 가위(주먹 + 두 손가락)
    function makePatternScissors(){
      const p = blank();
      // 주먹 바디(바위와 유사)
      const base = makePatternRock();
      for(let y=0;y<N;y++) for(let x=0;x<N;x++) if(base[y][x]) p[y][x]=true;

      // 두 손가락(검지/중지) 위로
      line(p, 12, 6, 12, 13);
      line(p, 16, 6, 16, 13);

      // 손가락 끝 둥글게
      for(let x=11; x<=13; x++) setDot(p,x,5);
      for(let x=15; x<=17; x++) setDot(p,x,5);

      // 손가락 사이 살짝 벌림
      p[9][14]=false; p[10][14]=false;

      return p;
    }

    // 보(펼친 손)
    function makePatternPaper(){
      const p = blank();
      // 손바닥
      for(let y=10; y<=23; y++){
        for(let x=8; x<=20; x++){
          const cx=14, cy=17;
          const rx=7.4, ry=7.6;
          const v = ((x-cx)*(x-cx))/(rx*rx) + ((y-cy)*(y-cy))/(ry*ry);
          if(v<=1.0) setDot(p,x,y);
        }
      }
      // 손가락 5개
      for(let f=0; f<5; f++){
        const fx = 9 + f*3; // 9,12,15,18,21(마지막은 약간 조정)
        const top = 5;
        const bottom = 11;
        const adj = (f===4) ? -1 : 0;
        for(let y=top; y<=bottom; y++){
          setDot(p, fx+adj, y);
          setDot(p, fx+adj+1, y);
        }
        // 둥근 끝
        setDot(p, fx+adj, top-1);
        setDot(p, fx+adj+1, top-1);
      }
      // 손목
      for(let y=23; y<=26; y++){
        for(let x=11; x<=17; x++) setDot(p,x,y);
      }
      return p;
    }
  </script>
</body>
</html>
