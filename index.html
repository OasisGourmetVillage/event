<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OASIS EVENT | Arcade RPS</title>
  <style>
    :root{
      --ink:#0b0f1a;
      --panel:#0f1422;
      --glass:rgba(0,0,0,.35);
      --line:rgba(255,255,255,.14);
      --muted:rgba(255,255,255,.78);
      --soft:rgba(255,255,255,.10);
      --shadow:0 22px 70px rgba(0,0,0,.55);
      --shadow2:0 12px 26px rgba(0,0,0,.35);
      --radius:22px;

      --red:#e04646;
      --blue:#2f76ff;
      --yellow:#f2c94c;
      --green:#27d17c;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      color:#fff;
      background:
        linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.55)),
        url("assets/bg.jpg") center/cover no-repeat fixed;
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 22px;
    }

    /* Cabinet */
    .cabinet{
      width:min(980px, 100%);
      border-radius: 28px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(2px);
    }

    /* Top marquee: black tone + small centered logo */
    .marquee{
      background: linear-gradient(180deg, #070707, #101010);
      border-bottom: 1px solid rgba(255,255,255,.10);
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .marquee::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(600px 80px at 50% 50%, rgba(255,255,255,.10), transparent 65%);
      opacity:.35;
      pointer-events:none;
    }
    .logo{
      height: 34px; /* 작게 */
      width:auto;
      filter: drop-shadow(0 0 10px rgba(255,255,255,.18));
      position:relative;
      z-index:1;
    }

    /* Main screen */
    .screen{
      padding: 18px;
      background: linear-gradient(180deg, rgba(8,10,16,.72), rgba(6,8,12,.78));
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1.15fr 1fr;
      gap: 14px;
      align-items: stretch;
    }

    .card{
      border-radius: var(--radius);
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      padding: 14px;
      box-shadow: var(--shadow2);
    }
    .title{
      font-weight: 900;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .sub{
      font-size: 12px;
      color: rgba(255,255,255,.72);
      line-height:1.45;
    }

    /* Streak panel */
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .stat{
      border-radius: 16px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.10);
      padding: 12px;
    }
    .stat .k{ font-size:12px; color: rgba(255,255,255,.72); }
    .stat .v{ margin-top:6px; font-weight: 1000; font-size: 26px; letter-spacing:.4px; }
    .accent{ color: var(--yellow); text-shadow: 0 0 14px rgba(242,201,76,.28); }

    /* Center arcade display */
    .display{
      position:relative;
      border-radius: 22px;
      background:
        radial-gradient(320px 260px at 50% 45%, rgba(0,0,0,.45), rgba(0,0,0,.88)),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.14);
      padding: 14px;
      overflow:hidden;
    }
    .scanlines::before{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.06),
        rgba(255,255,255,.06) 1px,
        transparent 2px,
        transparent 7px
      );
      opacity:.10;
      pointer-events:none;
    }

    .ring{
      width: 280px;
      height: 280px;
      border-radius: 999px;
      margin: 6px auto 0;
      background:
        radial-gradient(circle at 50% 50%, rgba(0,0,0,.25), rgba(0,0,0,.85)),
        conic-gradient(from 0deg,
          rgba(47,118,255,.85),
          rgba(224,70,70,.85),
          rgba(39,209,124,.85),
          rgba(242,201,76,.85),
          rgba(47,118,255,.85)
        );
      padding: 10px;
      box-shadow: 0 0 40px rgba(47,118,255,.12), 0 0 30px rgba(242,201,76,.10);
    }
    .ringInner{
      width:100%; height:100%;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 50%, #05060b, #0a0f1d);
      border: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }

    /* LED canvas */
    #led{
      width: 210px;
      height: 210px;
      display:block;
      border-radius: 16px;
      filter: drop-shadow(0 0 14px rgba(255,77,77,.18));
    }

    .centerText{
      text-align:center;
      margin-top: 10px;
    }
    .state{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-weight: 1000;
      letter-spacing: 2px;
      font-size: 22px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 0 12px rgba(255,255,255,.12);
    }
    .hint{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(255,255,255,.75);
      line-height: 1.4;
    }

    /* Buttons deck */
    .deck{
      padding: 16px 18px 18px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.35));
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .btnRow{
      display:flex;
      justify-content:center;
      gap: 16px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .arcBtn{
      width: 104px; height: 78px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 32px rgba(0,0,0,.45);
      cursor:pointer;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      letter-spacing:.2px;
      user-select:none;
      transition: transform .08s ease, box-shadow .08s ease, filter .08s ease;
    }
    .arcBtn:active{
      transform: translateY(2px) scale(.99);
      box-shadow: 0 10px 18px rgba(0,0,0,.45);
      filter: brightness(.95);
    }
    .arcBtn:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter: grayscale(.2);
    }
    .arcBtn .label{
      display:flex;
      align-items:center;
      gap:8px;
      font-size: 16px;
      color: rgba(255,255,255,.94);
      text-shadow: 0 0 10px rgba(0,0,0,.35);
    }
    .arcBtn .emoji{
      width: 28px; height: 28px;
      border-radius: 10px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
    }

    .red{ background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), rgba(0,0,0,.12)), linear-gradient(180deg, #ff5b5b, #b51f1f); }
    .blue{ background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), rgba(0,0,0,.12)), linear-gradient(180deg, #6aa8ff, #1f4ee6); }
    .yellow{ background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), rgba(0,0,0,.12)), linear-gradient(180deg, #ffe08a, #caa02a); }

    .result{
      text-align:center;
      margin-top: 14px;
      font-weight: 1000;
      letter-spacing:.3px;
      font-size: 18px;
      min-height: 26px;
    }
    .win{ color: var(--green); text-shadow: 0 0 14px rgba(39,209,124,.25); }
    .draw{ color: var(--blue); text-shadow: 0 0 14px rgba(47,118,255,.22); }
    .lose{ color: rgba(255,255,255,.70); }

    /* Coupon */
    .couponWrap{ display:none; margin-top: 14px; }
    .couponCard{
      max-width: 560px;
      margin: 0 auto;
      padding: 14px;
      border-radius: 18px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      text-align:center;
      box-shadow: var(--shadow2);
    }
    .couponCard .t{
      font-weight: 1000;
      letter-spacing:.2px;
      margin-bottom: 10px;
      color: rgba(255,255,255,.92);
    }
    .couponLine{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.86);
      word-break: break-all;
      line-height:1.4;
    }
    .rule{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(255,255,255,.70);
      line-height:1.45;
    }

    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
      .ring{ width: 260px; height: 260px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="cabinet">
      <!-- Top: black marquee + small logo -->
      <div class="marquee">
        <img class="logo" src="assets/oasis_logo_white.png" alt="OASIS" />
      </div>

      <div class="screen">
        <div class="grid">
          <!-- Left: streak -->
          <div class="card">
            <div class="title">
              <span>STREAK</span>
              <span class="sub">브라우저 저장</span>
            </div>
            <div class="sub">
              3연승: 30% 할인<br/>
              5연승: 50% 할인<br/>
              10연승: 100% 할인
            </div>

            <div class="stats">
              <div class="stat">
                <div class="k">현재 연승</div>
                <div class="v accent" id="streakNow">0</div>
              </div>
              <div class="stat">
                <div class="k">오늘 최고</div>
                <div class="v" id="streakMax">0</div>
              </div>
            </div>

            <div class="sub" style="margin-top:10px">
              * 버튼을 누르는 순간, 중앙 롤링이 멈추며 결과가 확정됩니다.<br/>
              * 패배 시 연승은 0으로 초기화됩니다.
            </div>
          </div>

          <!-- Center: LED rolling display -->
          <div class="display scanlines card">
            <div class="ring">
              <div class="ringInner">
                <canvas id="led" width="210" height="210" aria-label="LED"></canvas>
              </div>
            </div>
            <div class="centerText">
              <div class="state" id="stateText">ROLLING</div>
              <div class="hint" id="hintText">빨강/파랑/노랑 버튼을 눌러 멈추세요</div>
            </div>
          </div>

          <!-- Right: status & coupon -->
          <div class="card">
            <div class="title">
              <span>STATUS</span>
              <span class="sub">WIN / DRAW / LOSE</span>
            </div>
            <div class="sub" id="statusSub">
              현재는 롤링 중입니다. 버튼을 눌러 결과를 확정하세요.
            </div>

            <div class="couponWrap" id="couponWrap">
              <div class="couponCard">
                <div class="t" id="couponTitle">COUPON UNLOCKED</div>
                <div id="qrcode"></div>
                <div class="couponLine"><b>QR DATA:</b> <span id="couponText">-</span></div>
                <div class="rule">
                  * 계산대에서 제시해 주세요. (1회 사용 / 당일 유효)<br/>
                  * 운영 정책에 따라 캡처 허용 여부를 정해 주세요.
                </div>
              </div>
            </div>

            <div class="sub" style="margin-top:12px">
              ※ 보상/할인율은 코드 상단 설정(CONFIG)만 수정하면 언제든 변경 가능합니다.
            </div>
          </div>
        </div>
      </div>

      <!-- Buttons -->
      <div class="deck">
        <div class="sub" style="text-align:center; margin-top:2px;">
          안내: <b>버튼을 누르면 중앙 롤링이 멈추고</b> 결과가 확정됩니다.
        </div>

        <div class="btnRow">
          <button class="arcBtn red" id="btnScissors" onclick="press('가위')" aria-label="가위">
            <span class="label"><span class="emoji">✌️</span>가위</span>
          </button>
          <button class="arcBtn blue" id="btnRock" onclick="press('바위')" aria-label="바위">
            <span class="label"><span class="emoji">✊</span>바위</span>
          </button>
          <button class="arcBtn yellow" id="btnPaper" onclick="press('보')" aria-label="보">
            <span class="label"><span class="emoji">✋</span>보</span>
          </button>
        </div>

        <div class="result" id="resultText">READY</div>
      </div>
    </div>
  </div>

  <!-- QRCode.js -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script>
    /***********************************************************
     * ✅ 설정(나중에 수정은 여기만)
     ***********************************************************/
    const CONFIG = {
      qrPrefix: "OASIS",
      // 연승 보상(요청값)
      rewards: [
        { streak: 3,  title: "30% OFF",  code: "DISC30" },
        { streak: 5,  title: "50% OFF",  code: "DISC50" },
        { streak: 10, title: "100% OFF", code: "FREE100" }
      ],
      // 쿠폰 중복 발급 제한(티어별 1일 1회)
      dailyOnePerTier: true
    };

    /***********************************************************
     * LED DOT MATRIX (text/shape patterns)
     * - 원 테두리 글씨 없음
     * - 중앙에만 도트 아이콘 표시
     ***********************************************************/
    const canvas = document.getElementById("led");
    const ctx = canvas.getContext("2d");

    // 21x21 grid
    const N = 21;
    const size = canvas.width;
    const cell = Math.floor(size / N);
    const pad = Math.floor(cell * 0.18);

    // Patterns (21x21) : 1=on, 0=off
    // 간단하지만 "가위/바위/보"가 명확하게 보이도록 픽셀패턴 제작
    const PAT = {
      "가위": [
        "000000001110000000000",
        "000000011111000000000",
        "000000111111100000000",
        "000001110011110000000",
        "000011100001111000000",
        "000111000000111100000",
        "001110000000011110000",
        "001100000000001110000",
        "001100000000001110000",
        "001110000000011110000",
        "000111000000111100000",
        "000011100001111000000",
        "000001110011110000000",
        "000000111111100000000",
        "000000011111000000000",
        "000000001110000000000",
        "000000000100000000000",
        "000000000100000000000",
        "000000000100000000000",
        "000000000000000000000",
        "000000000000000000000",
      ],
      "바위": [
        "000000000000000000000",
        "000000001111000000000",
        "000000011111100000000",
        "000000111111110000000",
        "000001111111111000000",
        "000011111111111100000",
        "000111111111111110000",
        "001111111111111111000",
        "001111111111111111000",
        "001111111111111111000",
        "001111111111111111000",
        "000111111111111110000",
        "000011111111111100000",
        "000001111111111000000",
        "000000111111110000000",
        "000000011111100000000",
        "000000001111000000000",
        "000000000000000000000",
        "000000000000000000000",
        "000000000000000000000",
        "000000000000000000000",
      ],
      "보": [
        "000000000111000000000",
        "000000001111100000000",
        "000000011111110000000",
        "000000111111111000000",
        "000001111111111100000",
        "000011111111111110000",
        "000111111111111111000",
        "001111111111111111100",
        "001111111111111111100",
        "001111111111111111100",
        "001111111111111111100",
        "000111111111111111000",
        "000011111111111110000",
        "000001111111111100000",
        "000000111111111000000",
        "000000011111110000000",
        "000000001111100000000",
        "000000000111000000000",
        "000000000000000000000",
        "000000000000000000000",
        "000000000000000000000",
      ]
    };

    function drawLED(choice, glowColor){
      // background
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // subtle vignette
      const g = ctx.createRadialGradient(size*0.5, size*0.5, size*0.1, size*0.5, size*0.5, size*0.55);
      g.addColorStop(0, "rgba(0,0,0,.10)");
      g.addColorStop(1, "rgba(0,0,0,.65)");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,size,size);

      const pat = PAT[choice];
      for(let y=0;y<N;y++){
        for(let x=0;x<N;x++){
          const on = pat[y][x] === "1";
          const cx = x*cell + Math.floor(cell/2);
          const cy = y*cell + Math.floor(cell/2);
          const r = Math.floor((cell - pad*2)/2);

          // off dot
          ctx.beginPath();
          ctx.arc(cx, cy, r, 0, Math.PI*2);
          ctx.fillStyle = "rgba(255,255,255,.06)";
          ctx.fill();

          if(on){
            // glow
            ctx.beginPath();
            ctx.arc(cx, cy, r+2, 0, Math.PI*2);
            ctx.fillStyle = glowColor;
            ctx.globalAlpha = 0.22;
            ctx.fill();
            ctx.globalAlpha = 1;

            // on dot
            ctx.beginPath();
            ctx.arc(cx, cy, r, 0, Math.PI*2);
            ctx.fillStyle = glowColor;
            ctx.fill();
          }
        }
      }
    }

    /***********************************************************
     * Game logic
     ***********************************************************/
    const stateText = document.getElementById("stateText");
    const hintText = document.getElementById("hintText");
    const resultText = document.getElementById("resultText");
    const statusSub = document.getElementById("statusSub");

    const streakNowEl = document.getElementById("streakNow");
    const streakMaxEl = document.getElementById("streakMax");

    const btnScissors = document.getElementById("btnScissors");
    const btnRock = document.getElementById("btnRock");
    const btnPaper = document.getElementById("btnPaper");

    const couponWrap = document.getElementById("couponWrap");
    const couponTitle = document.getElementById("couponTitle");
    const couponText = document.getElementById("couponText");
    const qrEl = document.getElementById("qrcode");

    const choices = ["가위","바위","보"];
    const glowMap = {
      "가위": "rgba(224,70,70,1)",
      "바위": "rgba(47,118,255,1)",
      "보": "rgba(242,201,76,1)"
    };

    let rolling = true;
    let rollIdx = 0;
    let rollTimer = null;
    let cpuChoice = "가위";

    let streakNow = 0;
    let streakMax = 0;

    function todayKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${y}${m}${dd}`;
    }

    function loadStreak(){
      const t = todayKey();
      const savedDay = localStorage.getItem("dayKey");
      if(savedDay !== t){
        localStorage.setItem("dayKey", t);
        localStorage.setItem("streakMax", "0");
        localStorage.setItem("streakNow", "0");
      }
      streakNow = parseInt(localStorage.getItem("streakNow") || "0", 10);
      streakMax = parseInt(localStorage.getItem("streakMax") || "0", 10);
      renderStreak();
    }

    function saveStreak(){
      localStorage.setItem("streakNow", String(streakNow));
      localStorage.setItem("streakMax", String(streakMax));
    }

    function renderStreak(){
      streakNowEl.textContent = streakNow;
      streakMaxEl.textContent = streakMax;
    }

    function startRolling(){
      rolling = true;
      stateText.textContent = "ROLLING";
      hintText.textContent = "빨강/파랑/노랑 버튼을 눌러 멈추세요";
      resultText.className = "result";
      resultText.textContent = "READY";
      statusSub.textContent = "현재는 롤링 중입니다. 버튼을 눌러 결과를 확정하세요.";

      enableButtons(true);
      hideCoupon();

      if(rollTimer) clearInterval(rollTimer);
      rollTimer = setInterval(() => {
        cpuChoice = choices[rollIdx % 3];
        rollIdx++;
        drawLED(cpuChoice, glowMap[cpuChoice]);
      }, 95);
    }

    function enableButtons(on){
      btnScissors.disabled = !on;
      btnRock.disabled = !on;
      btnPaper.disabled = !on;
    }

    function stopRolling(){
      rolling = false;
      if(rollTimer) clearInterval(rollTimer);
      rollTimer = null;
      stateText.textContent = "STOP";
      hintText.textContent = "결과가 확정되었습니다";
    }

    function judge(me, cpu){
      if(me === cpu) return "DRAW";
      if(
        (me==="가위" && cpu==="보") ||
        (me==="바위" && cpu==="가위") ||
        (me==="보" && cpu==="바위")
      ) return "WIN";
      return "LOSE";
    }

    function bestRewardForStreak(streak){
      // 가장 높은 티어 우선
      const sorted = [...CONFIG.rewards].sort((a,b)=>b.streak-a.streak);
      return sorted.find(r => streak >= r.streak) || null;
    }

    function issuedKey(code){
      return `issued:${todayKey()}:${code}`;
    }

    function buildQRPayload(code, tierStreak){
      const rand = Math.random().toString(16).slice(2,8).toUpperCase();
      // OASIS|DISC30|20260108|A1B2C3|TIER3|NOW5
      return `${CONFIG.qrPrefix}|${code}|${todayKey()}|${rand}|TIER${tierStreak}|NOW${streakNow}`;
    }

    function showCoupon(reward){
      const key = issuedKey(reward.code);
      if(CONFIG.dailyOnePerTier && localStorage.getItem(key) === "1"){
        // 이미 발급 완료
        couponWrap.style.display = "block";
        couponTitle.textContent = `COUPON UNLOCKED (${reward.title})`;
        couponText.textContent = "ALREADY ISSUED TODAY";
        qrEl.innerHTML = "";
        return;
      }

      localStorage.setItem(key, "1");

      const payload = buildQRPayload(reward.code, reward.streak);
      couponWrap.style.display = "block";
      couponTitle.textContent = `COUPON UNLOCKED (${reward.title})`;
      couponText.textContent = payload;
      qrEl.innerHTML = "";
      new QRCode(qrEl, { text: payload, width: 200, height: 200 });
    }

    function hideCoupon(){
      couponWrap.style.display = "none";
      couponText.textContent = "-";
      qrEl.innerHTML = "";
    }

    function press(meChoice){
      if(!rolling) return;

      // 버튼 누른 순간: CPU는 현재 롤링 값으로 확정
      stopRolling();
      enableButtons(false);

      const outcome = judge(meChoice, cpuChoice);

      // 결과 반영
      if(outcome === "WIN"){
        streakNow += 1;
        if(streakNow > streakMax) streakMax = streakNow;
        resultText.className = "result win";
        resultText.textContent = "WIN";
        statusSub.textContent = `YOU: ${meChoice} / CPU: ${cpuChoice} → WIN (현재 ${streakNow}연승)`;

      } else if(outcome === "DRAW"){
        // 무승부는 연승 유지(요청에 명시 없어서 운영 편의상 유지로 설정)
        resultText.className = "result draw";
        resultText.textContent = "DRAW";
        statusSub.textContent = `YOU: ${meChoice} / CPU: ${cpuChoice} → DRAW (현재 ${streakNow}연승 유지)`;

      } else {
        streakNow = 0;
        resultText.className = "result lose";
        resultText.textContent = "LOSE";
        statusSub.textContent = `YOU: ${meChoice} / CPU: ${cpuChoice} → LOSE (연승 초기화)`;
      }

      saveStreak();
      renderStreak();

      // 중앙 LED는 멈춘 상태에서 결과 색감을 살짝 강조
      drawLED(cpuChoice, glowMap[cpuChoice]);

      // 보상 체크
      const reward = bestRewardForStreak(streakNow);
      if(reward){
        showCoupon(reward);
      } else {
        hideCoupon();
      }

      // 1.2초 후 자동으로 다시 롤링(오락기 느낌)
      setTimeout(() => startRolling(), 1200);
    }

    // Init
    loadStreak();
    drawLED("가위", glowMap["가위"]);
    startRolling();
  </script>
</body>
</html>
